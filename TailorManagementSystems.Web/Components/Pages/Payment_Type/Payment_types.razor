@page "/payment_types"
@rendermode InteractiveServer
@inject ILogger<Payment_types> Logger
@inject IPayment_TypeService Payment_TypeService
@inject SweetAlertService Alert
@using TailorManagementSystems.Application.Common
@using TailorManagementSystems.Application.Common.Pagination
@using TailorManagementSystems.Application.DTO.Payment_Types
@using TailorManagementSystems.Application.Interfaces
@using TailorManagementSystems.Application.Interfaces.Payment_Types
@using TailorManagementSystems.Application.Models
@using TailorManagementSystems.Application.Models.Payment_Types
@using TailorManagementSystems.Infrastructure.Persistence.Scaffold
@using TailorManagementSystems.Infrastructure.Services
@using TailorManagementSystems.Infrastructure.Services.Sweetalert

<h3 class="mb-3">Data Payment type management</h3>
@if (response == null)
{
    <p>Loading...</p>
}
else if (!response.Success)
{
    <div class="alert alert-danger">
        @response.Message
    </div>
}
else
{
    <div class="row mb-2">
        <div class="col-md-2 mb-2">
            <input type="text" class="form-control form-control-sm" placeholder="Cari payment type..." value="@searchText"
                @oninput="OnSearchChanged" />
        </div>
        <div class="col-md-10 text-end">
            <a href="/payment_types/create" class="btn btn-primary btn-sm">Tambah Payment type</a>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-hover table-striped align-middle shadow-sm">
            <thead class="table-dark text-uppercase small">
                <tr>
                    <th>Nama Payment type</th>
                    <th>Deskripsi</th>
                    <th>Row Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @if (response.Data?.TotalItems == 0)
                {
                    <tr>
                        <td colspan="5">Data tidak ditemukan...</td>
                    </tr>
                }
                else
                {
                    @foreach (var c in response.Data.Items)
                    {
                        <tr @key="@c.Id">
                            <td class="fw-semibold">@c.Name</td>
                            <td>@c.Description</td>
                            <td>@c.RowStatus</td>
                            <td>
                                <a href="/payment_types/edit/@c.Id"><i class="fa fa-edit"></i></a>
                                <button class="btn btn-link text-danger p-0" title="Hapus" @onclick="() => Delete(c.Id)">
                                    <i class="fa fa-trash"></i>
                                </button>

                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
        <ul class="pagination" @key="response.Data.Page">
            @for (int i = 1; i <= response?.Data?.TotalPages; i++)
            {
                var pageNumber = i;
                <li class="page-item @(i == currentPage ? "active" : "")">
                    <button type="button" class="page-link" @onclick="() => LoadPage(pageNumber)">
                        @i
                    </button>
                </li>
            }
        </ul>
        <p>Page @currentPage of @response?.Data.TotalPages</p>
    </div>
}

@code {
    private Response<PagedResult<Payment_TypeDTO>>? response;
    private int currentPage = 1;
    private int pageSize = 10;
    private string? searchText;
    private CancellationTokenSource? searchCts;

    protected override async Task OnInitializedAsync()
    {
        await LoadPage(1);
    }

    private async Task LoadPage(int page)
    {
        response = null;
        currentPage = page;
        var result = await Payment_TypeService.GetAllAsync(new PagedRequest
        {
            Page = currentPage,
            PageSize = pageSize,
            Search = searchText
        });
        response = result;
        StateHasChanged();
    }

    private async Task OnSearchChanged(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString();
        searchCts?.Cancel();
        searchCts = new CancellationTokenSource();
        var token = searchCts.Token;
        try
        {
            await Task.Delay(500, token); // Debounce delay
            if (!token.IsCancellationRequested)
            {
                await LoadPage(1);
            }
        }
        catch (TaskCanceledException)
        {
            // Ignore cancellation
        }
    }

    private async Task Delete(int id)
    {
        if (!await Alert.Confirm("Hapus Data", "Apakah Anda yakin ingin menghapus pelanggan ini?"))
            return;

        var result = await Payment_TypeService.DeleteAsync(id);

        if (!result.Success)
        {
            await Alert.Error("Gagal", result.Message);
            return;
        }

        await Alert.Success("Berhasil", result.Message);

        await LoadPage(currentPage);
    }

}